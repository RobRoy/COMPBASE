<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>Kompetenzverwaltung</title>
    <script src="jquery-2.1.4.js"></script>
</head>
<body>

<h1> Kompetenzverwaltung </h1>
<center>
Dein Benutzername: <input type="text" id="username_textfield"> <br>

<hr />

<!--Erstellen der beiden grundlegenden Buttons mit Aufruf der Methoden-->

<input type="button" onclick="loadCompetences()" value="Alle verf&uuml;gbaren Kompetenzen laden">

<input type="button" onclick="load_users_competences()" id="button_load_user_competences" value="Gelernte Kompetenzen des Nutzers laden">

</center>

<!--Angabe der Formatierung der jeweils aufgerufenen Liste -->

        <div style="height:450px;overflow:auto;padding:6px;">
            
        <ul id="all_available_comptences_list">
            </ul>
        
        <ul id="learned_competences_list">
            </ul>
            
        </div>
<br>

<!--Hinzufügen des Textfeldes und des Buttons zum Eintragen der Kommentare zu den Kompetenzen -->

 Kommentar zur ausgewählten Kompetenz: <input type="text" id="comment_box">
    <input type="button" onclick="save_comment()" value="Kommentar zur gewählten Kompetenz hinzufügen">




<!--Kompetenzen kommentieren-->
<div id="competence_comment_area">


</div>

<script>

//    $("#competence_comment_area").hide();

    function loadCompetences() {

//        falls vorhanden, bereits geladene mögliche oder gelernte Kompetenzen löschen
        $(".headline").remove();
        $(".available_competence").remove();
        $(".learned_competences").remove();
        $(".competence_comment").remove();


//        Benutzername muss länger als 2 Zeichen sein
        var username_pattern = /[a-zA-z]{3,}/;
        var username = document.getElementById("username_textfield").value;


        if (username_pattern.test(username)) {
            $.get("http://localhost:8084/competences/xml/competencetree/university/all/nocache", function (data, status) {


                $(data).find('competence').each(function () {

                    var kompetenz_text = $(this).attr("name");

                    var hasChildren = $(this).children('competence').length > 0;

                    if (hasChildren) {
                        $("#all_available_comptences_list").append('<li class="headline">' + kompetenz_text + '</li>');
                    }
                    else {


                        $("#all_available_comptences_list").append('<li class="available_competence">' + kompetenz_text + '</li>');
                    }


                });
                
 // Hinzufügen einer möglichen Kompetenz zu den erlernten Kompetenzen durch einfaches Anklicken
        
                $(".available_competence").click(function () {

                    $(this).css("color", "green");
                    set_learned_competence($(this).html());

                });
            });
            $("#competence_comment_area").show();
        } 
        else {alert("Benutzername muss mindestens 3 Zeichen lang sein.");}
    }


//      Funktion zum Übertragen einer Kompetenz in die anwenderbezogene Liste der gelernten Kompetenzen 

    function set_learned_competence(competence_text) {

        var username = document.getElementById("username_textfield").value;


        $.ajax({
            method: "POST",
            url: "http://localhost:8084/competences/json/link/create/university/tony/teacher/" + username + "?competences=" + competence_text + "&evidences=app,link",
            accepts: {
                json: 'application/json'
            },
            contentType: "application/json"

        });

        check_for_prerequisite_competence(competence_text);
    }

//      Funktion für das Laden der anwenderbezogenen Liste der gelernten Kompetenzen

    function load_users_competences() {

        //wenn vorhanden, bereits geladene gelernte Kompetenzen löschen
        $(".learned_competences").remove();
        $(".competence_comment").remove();
        


        var username = document.getElementById("username_textfield").value;

        $.getJSON("http://localhost:8084/competences/json/link/overview/" + username, function (data, status) {


            $.each(data.mapUserCompetenceLinks, function (key, value) {
                
                //Auflistung der gelernten Kompetenzen

                $('#learned_competences_list').append('<li class="learned_competences">' + key + '<input type="radio" name="has_comment" value="' + value[0].abstractLinkId + '" >' + '</li>');
                
                $.each(value[0].comments,function(key2,value2){
                   
                    //Jeder Kompetenz werden die gespeicherten Kommentare angehangen, wobei zuvor abgefragt wird, ob das Kommentar vom aktuellen Anwender stammt
                    
                    if (value2.userName === username) {
                        var comment_text = '<ul { list-style: none } class="learned_competences">' + '&#8594' +  value2.commentName + '</ul>';
                        $('#learned_competences_list').append(comment_text);
                    }
                  });  
            });

        });

        $(".headline").remove();
        $(".available_competence").remove();


    }


    //Funktion zum speichern des anwenderbezogenen Kommentares zur ausgewählten Kompetenz
    
    function save_comment() {

       
        var comment = document.getElementById("comment_box").value;
        var abstractlink = $("input:checked").val();
        var creator_name = document.getElementById("username_textfield").value;

        if ($("input:checked").length > 0) {
           
        $.ajax({
            method: "POST",
            url: "http://localhost:8084/competences/json/link/comment/" + abstractlink + "/" + creator_name + "/university/teacher?text=" + comment,
            accepts: {
                json: 'application/json'
            },
            contentType: "application/json"

            });
            //Das Abspeichern des Kommentares dauert Serverbedingt etwas, danach wird neu geladen, um die neue Kompetenz direkt anzuzeigen 
            setTimeout(load_users_competences, 1000);
            }
            else { alert("Wählen sie eine Kompetenz aus!"); }
                
                
                
        }

    function check_for_prerequisite_competence(learned_competence_text) {

        var competence_list = [];

//        Graph für relationen laden
        $.getJSON("http://localhost:8084/competences/json/prerequisite/graph/university", function (data, status) {

            $.each(data.triples, function (key, value) {

                competence_list.push(value.fromNode);

            });
            console.log(competence_list);

            if ($.inArray(learned_competence_text, competence_list) !== -1) {
                alert("Neue Komepetenz(en) freigeschaltet!");
                setTimeout(loadCompetences(), 1000);
            }

        });


    }


</script>
</body>
</html>