Raphael.fn.freeTransform=function(e,k,h){if(e.freeTransform){return e.freeTransform}if(!("map" in Array.prototype)){Array.prototype.map=function(o,l){var m=new Array();for(var n in this){if(this.hasOwnProperty(n)){m[n]=o.call(l,this[n],n,this)}}return m}}var a=this;var i=e.getBBox(true);var c=e.freeTransform={attrs:{x:i.x,y:i.y,size:{x:i.width,y:i.height},center:{x:i.x+i.width/2,y:i.y+i.height/2},rotate:0,scale:{x:1,y:1},translate:{x:0,y:0}},axes:null,bbox:null,callback:null,items:new Array,handles:{center:null,x:null,y:null},offset:{rotate:0,scale:{x:1,y:1},translate:{x:0,y:0}},opts:{attrs:{fill:"#000",stroke:"#000"},boundary:{x:a._left?a._left:0,y:a._top?a._top:0,width:a.width,height:a.height},distance:1.2,drag:true,dragRotate:false,dragScale:false,dragSnap:false,dragSnapDist:0,keepRatio:false,rotate:true,rotateRange:[-180,180],rotateSnap:false,rotateSnapDist:0,scale:true,scaleSnap:false,scaleRange:false,showBBox:false,size:5},subject:e};c.updateHandles=function(){if(c.opts.showBBox||c.opts.dragRotate){var n=j()}var m={x:(c.attrs.rotate)*Math.PI/180,y:(c.attrs.rotate+90)*Math.PI/180};var l={x:c.attrs.size.x/2*c.attrs.scale.x,y:c.attrs.size.y/2*c.attrs.scale.y};c.axes.map(function(p){if(c.handles[p]){var o=c.attrs.center.x+c.attrs.translate.x+l[p]*c.opts.distance*Math.cos(m[p]),q=c.attrs.center.y+c.attrs.translate.y+l[p]*c.opts.distance*Math.sin(m[p]);if(c.opts.boundary){o=Math.max(Math.min(o,c.opts.boundary.x+c.opts.boundary.width),c.opts.boundary.x),q=Math.max(Math.min(q,c.opts.boundary.y+c.opts.boundary.height),c.opts.boundary.y)}c.handles[p].disc.attr({cx:o,cy:q});c.handles[p].line.toFront().attr({path:[["M",c.attrs.center.x+c.attrs.translate.x,c.attrs.center.y+c.attrs.translate.y],["L",c.handles[p].disc.attrs.cx,c.handles[p].disc.attrs.cy]]});c.handles[p].disc.toFront()}});if(c.handles.center){c.handles.center.disc.toFront().attr({cx:c.attrs.center.x+c.attrs.translate.x,cy:c.attrs.center.y+c.attrs.translate.y})}if(c.opts.showBBox){c.bbox.toFront().attr({path:[["M",n[0].x,n[0].y],["L",n[1].x,n[1].y],["L",n[2].x,n[2].y],["L",n[3].x,n[3].y],["L",n[0].x,n[0].y]]})}if(c.opts.dragRotate){var l=Math.max(Math.sqrt(Math.pow(n[1].x-n[0].x,2)+Math.pow(n[1].y-n[0].y,2)),Math.sqrt(Math.pow(n[2].x-n[1].x,2)+Math.pow(n[2].y-n[1].y,2)))/2;c.circle.attr({cx:c.attrs.center.x+c.attrs.translate.x,cy:c.attrs.center.y+c.attrs.translate.y,r:l*c.opts.distance})}};c.showHandles=function(){c.hideHandles();if(c.opts.rotate||c.opts.scale){c.axes.map(function(m){c.handles[m]=new Object;c.handles[m].line=a.path(["M",c.attrs.center.x,c.attrs.center.y]).attr({stroke:c.opts.attrs.stroke,"stroke-dasharray":"- ",opacity:0.5});c.handles[m].disc=a.circle(c.attrs.center.x,c.attrs.center.y,c.opts.size).attr(c.opts.attrs)})}if(c.opts.drag){c.handles.center=new Object;c.handles.center.disc=a.circle(c.attrs.center.x,c.attrs.center.y,c.opts.size).attr(c.opts.attrs)}if(c.opts.showBBox){c.bbox=a.path("").attr({stroke:c.opts.attrs.stroke,"stroke-dasharray":"- ",opacity:0.5})}if(c.opts.dragRotate||c.opts.dragScale){c.circle=a.circle(0,0,0).attr({stroke:c.opts.attrs.stroke,"stroke-dasharray":"- ",opacity:0.3})}c.axes.map(function(m){if(!c.handles[m]){return}c.handles[m].disc.drag(function(r,q){if(c.o.viewBoxRatio){r*=c.o.viewBoxRatio.x;q*=c.o.viewBoxRatio.y}var p=r+c.handles[m].disc.ox,t=q+c.handles[m].disc.oy;var s={x:c.o.scale.x<0,y:c.o.scale.y<0};if(c.opts.rotate){var o=Math.atan2(t-c.o.center.y-c.o.translate.y,p-c.o.center.x-c.o.translate.x);c.attrs.rotate=o*180/Math.PI-(m=="y"?90:0);if(s[m]){c.attrs.rotate-=180}}if(c.opts.boundary){p=Math.max(Math.min(p,c.opts.boundary.x+c.opts.boundary.width),c.opts.boundary.x);t=Math.max(Math.min(t,c.opts.boundary.y+c.opts.boundary.height),c.opts.boundary.y)}var n=Math.sqrt(Math.pow(p-c.o.center.x-c.o.translate.x,2)+Math.pow(t-c.o.center.y-c.o.translate.y,2));if(c.opts.scale){c.attrs.scale={x:m=="x"?n/(c.o.size.x/2*c.opts.distance):c.o.scale.x,y:m=="y"?n/(c.o.size.y/2*c.opts.distance):c.o.scale.y};if(s[m]){c.attrs.scale[m]*=-1}}d();if(c.attrs.scale.x&&c.attrs.scale.y){c.apply()}f([c.opts.rotate?"rotate":null,c.opts.scale?"scale":null])},function(){c.o=b(c.attrs);if(a._viewBox){c.o.viewBoxRatio={x:a._viewBox[2]/a.width,y:a._viewBox[3]/a.height}}c.handles[m].disc.ox=this.attrs.cx;c.handles[m].disc.oy=this.attrs.cy;f([c.opts.rotate?"rotate start":null,c.opts.scale?"scale start":null])},function(){f([c.opts.rotate?"rotate end":null,c.opts.scale?"scale end":null])})});if(c.opts.drag){var l=new Array;if(!c.opts.dragRotate&&!c.opts.dragScale){l.push(e)}if(c.handles.center){l.push(c.handles.center.disc)}l.map(function(m){m.drag(function(o,n){if(c.o.viewBoxRatio){o*=c.o.viewBoxRatio.x;n*=c.o.viewBoxRatio.y}c.attrs.translate.x=c.o.translate.x+o;c.attrs.translate.y=c.o.translate.y+n;var p=b(c.o.bbox);p.x+=o;p.y+=n;d(p);c.apply();f(["drag"])},function(){c.o=b(c.attrs);if(c.opts.dragSnap){c.o.bbox=e.getBBox()}if(a._viewBox){c.o.viewBoxRatio={x:a._viewBox[2]/a.width,y:a._viewBox[3]/a.height}}c.axes.map(function(n){if(c.handles[n]){c.handles[n].disc.ox=c.handles[n].disc.attrs.cx;c.handles[n].disc.oy=c.handles[n].disc.attrs.cy}});f(["drag start"])},function(){f(["drag end"])})})}if(c.opts.dragRotate||c.opts.dragScale){e.drag(function(q,p,o,s){if(c.opts.dragRotate){var n=Math.atan2(s-c.o.center.y-c.o.translate.y,o-c.o.center.x-c.o.translate.x);c.attrs.rotate=c.o.rotate+(n*180/Math.PI)-c.o.deg}var r={x:c.o.scale.x<0,y:c.o.scale.y<0};if(c.opts.dragScale){var m=Math.sqrt(Math.pow(o-c.o.center.x-c.o.translate.x,2)+Math.pow(s-c.o.center.y-c.o.translate.y,2));c.attrs.scale.x=c.attrs.scale.y=(r.x?-1:1)*c.o.scale.x+(m-c.o.radius)/(c.o.size.x/2);if(r.x){c.attrs.scale.x*=-1}if(r.y){c.attrs.scale.y*=-1}}d();c.apply();f([c.opts.dragRotate?"rotate":null,c.opts.dragScale?"scale":null])},function(m,n){c.o=b(c.attrs);c.o.deg=Math.atan2(n-c.o.center.y-c.o.translate.y,m-c.o.center.x-c.o.translate.x)*180/Math.PI;c.o.radius=Math.sqrt(Math.pow(m-c.o.center.x-c.o.translate.x,2)+Math.pow(n-c.o.center.y-c.o.translate.y,2));if(a._viewBox){c.o.viewBoxRatio={x:a._viewBox[2]/a.width,y:a._viewBox[3]/a.height}}f([c.opts.dragRotate?"rotate start":null,c.opts.dragScale?"scale start":null])},function(){f([c.opts.dragRotate?"rotate end":null,c.opts.dragScale?"scale end":null])})}c.updateHandles()};c.hideHandles=function(){c.items.map(function(l){l.el.undrag()});if(c.handles.center){c.handles.center.disc.remove();c.handles.center=null}["x","y"].map(function(l){if(c.handles[l]){c.handles[l].disc.remove();c.handles[l].line.remove();c.handles[l]=null}});if(c.bbox){c.bbox.remove();c.bbox=null}if(c.circle){c.circle.remove();c.circle=null}};c.setOpts=function(l,n){c.callback=typeof n=="function"?n:false;for(var m in l){c.opts[m]=l[m]}if(!c.opts.scale){c.opts.keepRatio=true}c.axes=c.opts.keepRatio?["y"]:["x","y"];if(!c.opts.dragSnapDist){c.opts.dragSnapDist=c.opts.dragSnap}if(!c.opts.rotateSnapDist){c.opts.rotateSnapDist=c.opts.rotateSnap}c.opts.rotateRange=[parseInt(c.opts.rotateRange[0]),parseInt(c.opts.rotateRange[1])];c.showHandles();f(["init"])};c.setOpts(k,h);c.apply=function(){c.items.map(function(o,n){var l={x:c.attrs.center.x+c.offset.translate.x,y:c.attrs.center.y+c.offset.translate.y},m=c.attrs.rotate-c.offset.rotate;scale={x:c.attrs.scale.x/c.offset.scale.x,y:c.attrs.scale.y/c.offset.scale.y},translate={x:c.attrs.translate.x-c.offset.translate.x,y:c.attrs.translate.y-c.offset.translate.y};o.el.transform(["R",m,l.x,l.y,"S",scale.x,scale.y,l.x,l.y,"T",translate.x,translate.y]+c.items[n].transformString)});c.updateHandles()};c.unplug=function(){var l=c.attrs;c.hideHandles();delete e.freeTransform;return l};(e.type=="set"?e.items:[e]).map(function(l){c.items.push({el:l,attrs:{rotate:0,scale:{x:1,y:1},translate:{x:0,y:0}},transformString:l.matrix.toTransformString()})});c.items.map(function(m,l){if(m.el._&&m.el._.transform){m.el._.transform.map(function(n){if(n[0]){switch(n[0].toUpperCase()){case"T":c.items[l].attrs.translate.x+=n[1];c.items[l].attrs.translate.y+=n[2];break;case"S":c.items[l].attrs.scale.x*=n[1];c.items[l].attrs.scale.y*=n[2];break;case"R":c.items[l].attrs.rotate+=n[1];break}}})}});if(e.type!="set"){c.attrs.rotate=c.items[0].attrs.rotate;c.attrs.scale=c.items[0].attrs.scale;c.attrs.translate=c.items[0].attrs.translate;c.items[0].attrs={rotate:0,scale:{x:1,y:1},translate:{x:0,y:0}};c.items[0].transformString=""}function j(){var m={x:(c.attrs.rotate)*Math.PI/180,y:(c.attrs.rotate+90)*Math.PI/180};var l={x:c.attrs.size.x/2*c.attrs.scale.x,y:c.attrs.size.y/2*c.attrs.scale.y};var o=new Array,n=[{x:-1,y:-1},{x:1,y:-1},{x:1,y:1},{x:-1,y:1}];n.map(function(p){o.push({x:(c.attrs.center.x+c.attrs.translate.x+p.x*l.x*Math.cos(m.x))+p.y*l.y*Math.cos(m.y),y:(c.attrs.center.y+c.attrs.translate.y+p.x*l.x*Math.sin(m.x))+p.y*l.y*Math.sin(m.y)})});return o}function d(q){if(q&&c.opts.dragSnap){var n=q.x,r=q.y,p={x:0,y:0},m={x:0,y:0};[0,1].map(function(){p.x=n-Math.round(n/c.opts.dragSnap)*c.opts.dragSnap;p.y=r-Math.round(r/c.opts.dragSnap)*c.opts.dragSnap;if(Math.abs(p.x)<=c.opts.dragSnapDist){m.x=p.x}if(Math.abs(p.y)<=c.opts.dragSnapDist){m.y=p.y}n+=q.width-m.x;r+=q.height-m.y});c.attrs.translate.x-=m.x;c.attrs.translate.y-=m.y}if(c.opts.boundary){var l=c.opts.boundary;if(c.attrs.center.x+c.attrs.translate.x<l.x){c.attrs.translate.x+=l.x-(c.attrs.center.x+c.attrs.translate.x)}if(c.attrs.center.y+c.attrs.translate.y<l.y){c.attrs.translate.y+=l.y-(c.attrs.center.y+c.attrs.translate.y)}if(c.attrs.center.x+c.attrs.translate.x>l.x+l.width){c.attrs.translate.x+=l.x+l.width-(c.attrs.center.x+c.attrs.translate.x)}if(c.attrs.center.y+c.attrs.translate.y>l.y+l.height){c.attrs.translate.y+=l.y+l.height-(c.attrs.center.y+c.attrs.translate.y)}}if(c.opts.keepRatio){c.attrs.scale.x=c.attrs.scale.y}var p=Math.abs(c.attrs.rotate%c.opts.rotateSnap);p=Math.min(p,c.opts.rotateSnap-p);if(p<c.opts.rotateSnapDist){c.attrs.rotate=Math.round(c.attrs.rotate/c.opts.rotateSnap)*c.opts.rotateSnap}if(c.opts.scaleSnap){c.attrs.scale.x=Math.round(c.attrs.scale.x*c.attrs.size.x/c.opts.scaleSnap)*c.opts.scaleSnap/c.attrs.size.x;c.attrs.scale.y=Math.round(c.attrs.scale.y*c.attrs.size.y/c.opts.scaleSnap)*c.opts.scaleSnap/c.attrs.size.y}if(c.opts.rotateRange){var o=(360+c.attrs.rotate)%360;if(o>180){o-=360}if(o<c.opts.rotateRange[0]){c.attrs.rotate+=c.opts.rotateRange[0]-o}if(o>c.opts.rotateRange[1]){c.attrs.rotate+=c.opts.rotateRange[1]-o}}if(c.opts.scaleRange){}}function b(m){var n=new Object;for(var l in m){n[l]=typeof m[l]=="object"?b(m[l]):m[l]}return n}var g=false;function f(m){if(c.callback){var l=new Array();m.map(function(o,n){if(o){l.push(o)}});clearTimeout(g);setTimeout(function(){if(c.callback){c.callback(c,l)}},1)}}c.updateHandles();return c};